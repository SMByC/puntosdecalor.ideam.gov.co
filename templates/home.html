{% extends "base.html" %}

{% load staticfiles %}
{% load leaflet_tags %}
{% load geojson_tags %}

{% block leaflet_scripts %}

    {#  Area de estudio  #}
    {#  <script src="{% static "geojson/area_estudio.json" %}" type="text/javascript"></script>#}

    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        {% comment %}
        {#  Area de estudio  #}
        var area_estudio_style = {
            'color': '#004B96',
            'weight': 2,
            'opacity': 0.7
        };
        function add_area_estudio(map, options) {
            L.geoJson(area_estudio, {onEachFeature: popup, style: area_estudio_style}).addTo(map);
        }
        {% endcomment %}

        function popup(feature, layer) {
            if (feature.properties && feature.properties.name) {
                layer.bindPopup(feature.properties.name);
            }
        }

        {# apply extent #}
        function set_extent(map, options) {
            {# extent = [[lat-lng top-left], [lat-lng bottom-right]] #}
            map.fitBounds({{ extent_points }});
        }

        {# change the extent in url and form when the user move map #}
        function synchronize_extent(map, options) {
            map.on('moveend', function() {
                var u = new Url;  {# from scripts/url.min.js #}
                var bounds = map.getBounds();
                {# change locations maps #}
                {# nw_lat nw_lgn se_lat se_lng #}
                u.query.extent = "("+bounds.getNorthWest().lat+"_"+bounds.getNorthWest().lng
                                +"_"+bounds.getSouthEast().lat+"_"+bounds.getSouthEast().lng+")";

                {# update extent in hidden extent form #}
                $('input[name=extent]').val(u.query.extent);

                {# update extent in url get parameter #}
                var getParameters = '?' + u.query.toString();
                history.pushState('', '', getParameters);
            });
        }
    </script>

    {#  Puntos activos de incendios  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        var fireIcon = L.icon({
            iconUrl: "{% static "img/fire/active_fire.png" %}",
{#            shadowUrl: "{% static "img/fire/active_fire_shadow.png" %}", TODO #}

            iconSize: [18, 30], // size of the icon
            shadowSize: [37, 30], // size of the shadow

            iconAnchor: [9, 30], // point of the icon which will correspond to marker's location
            shadowAnchor: [4, 29],  // the same for the shadow
            popupAnchor: [0.5, -30] // point from which the popup should open relative to the iconAnchor
        });

        function add_active_fires(map, options) {
            {# L.marker([4, -80], {icon: fireIcon}).addTo(map).bindPopup("I am a green leaf.");#}
            {# L.marker([4, -80]).addTo(map).bindPopup("I am a green leaf.");#}

            var dataurl = "{% url 'data' %}" + "?" + "{{ get_parameters }}"
            // Download GeoJSON via Ajax
            $.getJSON(dataurl, function (data) {
                // Add GeoJSON layer
                L.geoJson(data, {
                    pointToLayer: function (feature, latlng) {
                    {# alert(JSON.stringify(feature, null, 4));#}
                        return L.marker(latlng, {icon: fireIcon}).addTo(map).bindPopup(feature.properties.popup_text);
                }});
            });
        }
    </script>

    {#  Cargar mapa  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        function load_map(map, options) {
            add_active_fires(map, options);
            {# add_area_estudio(map, options);#}
            set_extent(map, options);
            synchronize_extent(map, options)
        }
    </script>

    {#  Cargar mapa  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">


    </script>

{% endblock %}

{% block title %}
{% endblock %}

{% block menu-content %}
{% endblock %}

{% block content-map %}
    {% leaflet_map "active_fires_map" callback="window.load_map" %}
{% endblock %}

{% block content-items %}
    <div class="block-title" >Puntos activos de incendios</div>
    <form action="/new-parameters/" method="get">
        {# date range input #}
        <div class="block-subtitle" >Periodo</div>
        <div id="daterange" class="pull-right">
            <span class="glyphicon glyphicon-calendar fa fa-calendar"></span>
            {{ form.date_range }}
            <b class="caret" style="margin-left: -15px"></b>
        </div>
        {# extent input (hidden) #}
        <div>
            {{ form.extent.as_hidden }}
        </div>
        <input type="submit" value="Recalcular" />
    </form>
    <div class="block-subtitle" >Encontrados {{ qs_active_fires_in_period|length }} puntos activos:</div>

    <div id="active-fire-items" >
        {% for active_fire in qs_active_fires_in_period %}
            <div class="box-item">
                <p><b>Fecha:</b> {{ active_fire.date|date:"Y-m-d H:i" }}</p>
                <p><b>Satelite:</b> {{ active_fire.source }}</p>
            </div>
        {% endfor %}
    </div>
    <div id="link-active-fires-files">
        <a href="/ftp_files/">Archivos planos de puntos activos de incendios</a>
    </div>
    {% comment %}<div id="content-footer">
        <p>Puntos de incendios proveniente del sistema LANCE de los satelites de MODIS Terra & Aqua de la NASA</p>
    </div>{% endcomment %}
{% endblock %}