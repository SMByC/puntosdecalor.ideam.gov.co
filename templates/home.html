{% extends "base.html" %}

{% load staticfiles %}
{% load leaflet_tags %}
{% load geojson_tags %}

{% block leaflet_scripts %}

    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">

        function popup(feature, layer) {
            if (feature.properties && feature.properties.name) {
                layer.bindPopup(feature.properties.name);
            }
        }

        {# apply extent #}
        function set_extent(map, options) {
            {# extent = [[lat-lng top-left], [lat-lng bottom-right]] #}
            map.fitBounds({{ extent_points }});
        }

        {# change the extent in url and form when the user move map #}
        function synchronize_extent(map, options) {
            map.on('moveend', function() {
                var bounds = map.getBounds();
                {# change locations maps #}
                {# nw_lat nw_lgn se_lat se_lng #}
                var new_extent = "("+bounds.getNorthWest().lat+"_"+bounds.getNorthWest().lng
                                 +"_"+bounds.getSouthEast().lat+"_"+bounds.getSouthEast().lng+")";
                {# update extent in url get parameter #}
                updateUrlParameter("extent", new_extent);
            });
        }
    </script>

    {#  Puntos activos de incendios  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        var fireIcon = L.icon({
            iconUrl: "{% static "img/fire/active_fire.png" %}",
{#            shadowUrl: "{% static "img/fire/active_fire_shadow.png" %}", TODO #}

            iconSize: [18, 30], // size of the icon
            shadowSize: [37, 30], // size of the shadow

            iconAnchor: [9, 30], // point of the icon which will correspond to marker's location
            shadowAnchor: [4, 29],  // the same for the shadow
            popupAnchor: [0.5, -30] // point from which the popup should open relative to the iconAnchor
        });

        function add_active_fires(map, options) {
            {# L.marker([4, -80], {icon: fireIcon}).addTo(map).bindPopup("I am a green leaf.");#}
            {# L.marker([4, -80]).addTo(map).bindPopup("I am a green leaf.");#}

            var dataurl = "{% url 'data' %}" + "?" + "{{ get_parameters }}";
            // Download GeoJSON via Ajax
            $.getJSON(dataurl, function (data) {
                // Add GeoJSON layer
                L.geoJson(data, {
                    pointToLayer: function (feature, latlng) {
                    {# alert(JSON.stringify(feature, null, 4));#}
                        return L.marker(latlng, {icon: fireIcon}).addTo(map).bindPopup(feature.properties.popup_text);
                }});
            });
        }
    </script>

    {#  Cargar mapa  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        function load_map(map, options) {
            add_active_fires(map, options);
            {# add_area_estudio(map, options);#}
            set_extent(map, options);
            synchronize_extent(map, options)
        }
    </script>

    {#  Cargar mapa  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">


    </script>

{% endblock %}

{% block title %}
{% endblock %}

{% block menu-content %}
{% endblock %}

{% block content-map %}
    {% leaflet_map "active_fires_map" callback="window.load_map" %}
{% endblock %}

{% block lateral-content %}
    <div id="lateral-content-title" >Selección</div>
    <div id="lateral-content-update" >Última actualización:</div>
    {# date range input #}
    <div class="lateral-item">
        <div class="lateral-item-title" >Periodo</div>
        <div class="lateral-item-content" >Seleccione el periodo para mostrar los puntos de calor en el rango de fechas seleccionadas:
            <div id="date-range">
                De: <input id="date-range-from" size="9" value=""> a: <input id="date-range-to" size="9" value="">
            </div>
        </div>
    </div>

    {# Region #}
    <div class="lateral-item">
        <div class="lateral-item-title" >Region</div>
        <div class="lateral-item-content" >Seleccione la region para mostrar y filtrar los puntos de calor que estén dentro de él:</div>
        <div id="date-range">
            De: <input id="date-range-from" size="9" value=""> a: <input id="date-range-to" size="9" value="">
        </div>
    </div>

    {# Satellite #}
    <div class="lateral-item">
        <div class="lateral-item-title" >Satelite</div>
        <div class="lateral-item-content" >Seleccione el satelite origen para mostrar unicamente los detectados por éste:</div>
        <div id="date-range">
            De: <input id="date-range-from" size="9" value=""> a: <input id="date-range-to" size="9" value="">
        </div>
    </div>

    {# Result #}
    <div class="lateral-item">
        <div class="lateral-item-title" >Resultado</div>
        <div class="lateral-item-content" >
            Encontrados <span id="number-result">{{ qs_active_fires_in_period|length }}</span> puntos de calor.<br>
            Archivo csv de los resultados:<span class="link"><a href="/descargar-resultado/">descargar</a></span>
        </div>
    </div>

    <div id="footer-links">
        <span class="link">
            <a href="/acerca-de/">Acerca de</a>
        </span>
        <span class="link">
            <a href="/archivos-ftp/">Archivos ftp</a>
        </span>
    </div>
    {% comment %}<div id="content-footer">
        <p>Puntos de incendios proveniente del sistema LANCE de los satelites de MODIS Terra & Aqua de la NASA</p>
    </div>{% endcomment %}
{% endblock %}