{% extends "base.html" %}

{% load staticfiles %}
{% load leaflet_tags %}
{% load geojson_tags %}

{% block javascripts %}

    {#  General javascripts  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        {# apply extent #}
        function set_extent(map, options) {
            {# extent = [[lat-lng top-left], [lat-lng bottom-right]] #}
            map.fitBounds({{ extent }});
        }

        {# change the extent in url when the user move map #}
        function synchronize_extent(map, options) {
            map.on('moveend', function() {
                var bounds = map.getBounds();
                {# change locations maps #}
                {# nw_lat nw_lgn se_lat se_lng #}
                var new_extent = "("+bounds.getNorthWest().lat+"_"+bounds.getNorthWest().lng
                                 +"_"+bounds.getSouthEast().lat+"_"+bounds.getSouthEast().lng+")";
                {# update extent in url get parameter #}
                updateUrlParameter("extent", new_extent);
            });
        }

        $(function () {
            // fill the period from the url get parameters
            var from_date = getParameterByName("from_date");
            var to_date = getParameterByName("to_date");
            if ((from_date !== null) && (to_date !== null)) {
                $('#period').data('dateRangePicker').setDateRange(from_date, to_date);
            }

        });
    </script>

    {#  Leaflet and maps javascripts  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        var fireIcon = L.icon({
            iconUrl: "{% static "img/fire/active_fire.png" %}",
{#            shadowUrl: "{% static "img/fire/active_fire_shadow.png" %}", TODO #}

            iconSize: [18, 30], // size of the icon
            shadowSize: [37, 30], // size of the shadow

            iconAnchor: [9, 30], // point of the icon which will correspond to marker's location
            shadowAnchor: [4, 29],  // the same for the shadow
            popupAnchor: [0.5, -30] // point from which the popup should open relative to the iconAnchor
        });

        function active_fires(map, options) {
            $.ajaxSetup({async: true});
            // clear all markers in the map before add the new
            if ( typeof map.markers !== 'undefined') {
                map.removeLayer(map.markers);
            }
            var markers = new L.FeatureGroup();
            var data_url = "{% url 'active-fires' %}" + window.location.search;
            // Download GeoJSON via Ajax
            $.getJSON(data_url, function (data) {
                // Add GeoJSON layer
                L.geoJson(data, {
                    pointToLayer: function (feature, latlng) {
                        // market
                        // return L.marker(latlng, {icon: fireIcon}).addTo(map).bindPopup(feature.properties.popup_text);
                        var marker = L.marker(latlng, {
                            icon: L.divIcon({
                                html: '<svg transform="scale(1 1)" viewBox="-1 -1 2 2">  <circle cx="0" cy="0" r="0.9" fill-opacity="0.6" fill="#CC3D36" /></svg>'
                            })
                        });
                        // popup
                        marker.bindPopup("");
                        function onPopupClick(e) {
                            var popup = e.target.getPopup();
                            $.ajax({
                                url: "{% url 'get-popup' %}" + window.location.search,
                                data: {id: feature.properties.id},
                                dataType: 'json',
                                async: true,
                            })
                            .done(function(popup_text) {
                                popup.setContent(popup_text);
                                popup.update();
                            });
                        }
                        marker.on('click', onPopupClick );
                        // add this market
                        markers.addLayer(marker);
                }});
                // update the number of active fires result of ajax
                $('#number-result').text(data.features.length);
            });
            // add to map
            map.addLayer(markers);
            // save markers in map variable
            map.markers = markers;
        }
    </script>

    {#  Cargar mapa  #}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        function load_map(map, options) {
            set_extent(map, options);
            synchronize_extent(map, options);
            active_fires(map, options);

            // update the map after date change
            $('#period').on('datepicker-change', function (event, obj) {
                updateUrlParameter("from_date", moment(obj.date1).format("YYYY-MM-DD"));
                updateUrlParameter("to_date", moment(obj.date2).format("YYYY-MM-DD"));
                active_fires(map, options);
            });
        }
    </script>
{% endblock %}

{% block title %}
{% endblock %}

{% block menu-content %}
{% endblock %}

{% block content-map %}
    {% leaflet_map "active_fires_map" callback="window.load_map" %}
{% endblock %}

{% block lateral-content %}
    <div id="lateral-content-title" >Selección</div>
    <div id="lateral-content-update" >Última actualización: <span id="last-update">{{ last_update|date:"N j, Y, P" }}</span></div>
    {# date range input #}
    <div class="lateral-item">
        <div class="lateral-item-title" >Periodo</div>
        <div class="lateral-item-content" >Seleccione el periodo para mostrar los puntos de calor en el rango de fechas seleccionadas:
            <div id="period">
                De: <input id="from-date" size="7" value=""> a: <input id="to-date" size="7" value="">
            </div>
        </div>
    </div>

    {# Region #}
    <div class="lateral-item">
        <div class="lateral-item-title" >Region</div>
        <div class="lateral-item-content" >Seleccione la region para mostrar y filtrar los puntos de calor que estén dentro de éste:</div>
        <div id="region-div">
            <select id="region" name="region">

                <optgroup label="General">
                    <option value="colombia">Colombia</option>
                </optgroup>

                <optgroup label="Departamentos">
                {% for department in departments %}
                    <option value={{ department.slug }}>{{ department.name }}</option>
                {% endfor %}
                </optgroup>

                <optgroup label="Regiones Naturales">
                {% for department in departments %}
                    <option value={{ department.slug }}>{{ department.name }}</option>
                {% endfor %}
                </optgroup>

            </select>
        </div>
    </div>

{% comment %}
    {# Satellite #}
    <div class="lateral-item">
        <div class="lateral-item-title" >Satelite</div>
        <div class="lateral-item-content" >Seleccione el satelite origen para mostrar unicamente los detectados por éste:</div>
        <div id="">
            De: <input id="" size="9" value=""> a: <input id="to" size="9" value="">
        </div>
    </div>
{% endcomment %}

    {# Result #}
    <div class="lateral-item">
        <div class="lateral-item-title" >Resultado</div>
        <div class="lateral-item-content" >
            Encontrados <span id="number-result">...</span> puntos de calor.<br>
            Archivo csv de los resultados:<span class="link"><a href="/descargar-resultado/">descargar</a></span>
        </div>
    </div>

    <div id="footer-links">
        <span class="link">
            <a href="/acerca-de/">Acerca de</a>
        </span>
        <span class="link">
            <a href="/archivos-ftp/">Archivos ftp</a>
        </span>
    </div>
    {% comment %}<div id="content-footer">
        <p>Puntos de incendios proveniente del sistema LANCE de los satelites de MODIS Terra & Aqua de la NASA</p>
    </div>{% endcomment %}
{% endblock %}